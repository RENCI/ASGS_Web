{% load static %}
<!DOCTYPE html>
<meta charset="utf-8">
	<link rel="shortcut icon" href="{% static 'ASGS_Mon/images/favicon.png' %}" type="image/png">
	<link rel="icon" href="{% static 'ASGS_Mon/images/favicon.png' %}" type="image/png">
	<link rel="stylesheet" href="{% static 'ASGS_Mon/style.css' %}" type="text/css">	
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
	<script src="{% static 'ASGS_Mon/utilview.js' %}"></script>
	<script type="text/javascript">
		// create a title area and fill it
		d3.select("body")
			.append("div")
	  		.attr("id", "hdrdiv")
	  		.attr("style", "line-height: 50px; text-align:center; margin-top:-25px; margin-bottom:25px; font-size:20pt;")
	  		.text("ASGS Operational Awareness Dashboard")
	  				
		// set the location of the individual site component
		var margin = {top: 20, right: 15, bottom: 20, left: 15};
		
		// set the width of the individual site component
		var width = 400 - margin.left - margin.right;
	    
		// set the height of the individual site component
		var height = 50 - margin.top - margin.bottom;
	
		// init the site instance visualization component
		var siteInstance = d3.siteInstanceView()
	    	.width(width)
	    	.height(height);
		
		// TODO: check for browser support?
	 	if(typeof(EventSource) !== "undefined") 
	 	{
		 	// define the event endpoint 
	 		var eSource = new EventSource("http://localhost:8000/ASGS_Mon/event/");
		
	 		// detect message receipt
	 		eSource.onmessage = function(event) 
	 		{		 	 		
				// create/init the shells for all the site instances
				d3.json("http://localhost:8000/ASGS_Mon/init/", function(error, data)
				{
					// erase all the site instances on error
					if (error || data.length == 0) 
					{
						curRendered = d3.selectAll(".siteInstanceView").remove();
						return;
					}
						
					// get the current rendered items
					var curRendered = d3.selectAll(".siteInstanceView").selectAll("svg");
	
					// do we have a valid site instance defined
					if(Array.isArray(curRendered))
					{
						// loop through the rendered site instances and remove ones with no incoming data 
						for(i=0; i<curRendered.length; i++)
						{
							// reset the found flag
							bfound = false;
							
							// for each id in the incoming data
							for(j=0; j<data.length; j++)
							{
								// was it previously rendered
								if(curRendered[i].parentNode.id == data[j].eg_id)
								{
									// set the flag
									bfound = true;
									
									// no need to continue
									break;
								}
							}
							
							// if data for this rendered item is not found remove it
							if(!bfound)
								curRendered[i].parentNode.remove();
						}
					}
					
				  	// render the svg region for all individual site instances
				  	var svg = d3.select("body").selectAll("svg")
					    .data(data)
					    .enter().append("svg")
							.attr("class", "siteInstanceView")
							.attr("id", function(d) {return d.eg_id;} )
							.attr("width", width + margin.left + margin.right)
							.attr("height", height + margin.top + margin.bottom + 40)
					    .append("g")
							.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
							.call(siteInstance);
				  	
					// append the run parameters text
					svg.append("g")
				      	.style("text-anchor", "end")
						.attr("transform", "translate(" + width + ", -5)")
							.append("text")
								.attr("id", function(d) { return d.title.replace(" ", "") + "_params"; })
								.attr("class", "params")
								.text(function(d) { return ""; });					 	 		
	
					// append the event operation message text that goes inside the bar graph
					svg.append("g")
						.attr("transform", "translate(6," + height / 2 + ")")
							.append("text")
								.text(function(d) { return d.message; })
								.attr("id", function(d) { return d.title.replace(" ", "") + "_operation"; })
								.attr("class", "state")
								.attr("dy", ".35em");
					
					// create a region for the textual information
				  	var title = svg.append("g")
				      	.attr("transform", "translate(-10,-5)");
				
					// append the site name
					title.append("text")
					    .text(function(d) { return d.title + " - Process: TBD"; })
					    .attr("class", "title");
				  	  
					// append the process run state. colored RGB later
					title.append("text")
						.text(function(d) { return d.cluster_state; })
						.attr("id", function(d) { return d.title.replace(" ", "") + "_state"; })
						.attr("class", "stateSm")
						.attr("y", "40px")
						.attr("x", width/2 - 40);
					
					// append the summary text
					title.append("text")
						.text("textarea")
						.text(function(d) { return ""; })
						.attr("id", function(d) { return d.title.replace(" ", "") + "_eventSummary"; })
						.attr("class", "eventSummary")
						.attr("y", "55px")
				});
				
	 	 		// parse the incoming data object
	 	 		var theMsg = JSON.parse(event.data);
	 	 		 	 		
	 	 		// get a reference to the visualization component
	 			var svg = d3.select("body").selectAll("svg");
	 			
	 	 		// reload the visualization with the new data
	 			svg.data(theMsg.utilization).call(siteInstance.duration(1500));
	 		}
	 	}
	</script>
</body>
