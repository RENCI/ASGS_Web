{% load static %}
<!DOCTYPE html>
<meta charset="utf-8">
	<link rel="shortcut icon" href="{% static 'ASGS_Mon/images/favicon.png' %}" type="image/png">
	<link rel="icon" href="{% static 'ASGS_Mon/images/favicon.png' %}" type="image/png">
	<link rel="stylesheet" href="{% static 'ASGS_Mon/style.css' %}" type="text/css">	
<body>
	<script src="http://d3js.org/d3.v3.min.js"></script>
	<script src="https://d3js.org/d3-time-format.v2.min.js"></script>
	<script src="{% static 'ASGS_Mon/utilview.js' %}"></script>
	<script type="text/javascript">
	
		// set the exited run type id
		var _CONST_EXIT_MSG_TYPE = 9;
		
		// create a table for the title area
		var tbl = d3.select("body")
					.append("table")
			  		.attr("id", "pagehdr");
		
		// create a table row
		var tr = tbl.append("tr");
		
		// create a row column for the logo
		tr.append("td")
			.attr("align", "left")
					.html(function() {
						return "<img src=\"{% static 'ASGS_Mon/images/logo.jpg' %}\"/>";
					});
		
		// and another for the title				
		tr.append("td")
			.attr("text-align", "middle")
			.text("ASGS Operational Awareness Dashboard");
		
		// set the location of the individual site component
		var margin = {top: 15, right: 15, bottom: 20, left: 15};
		
		// set the width of the individual site instance component
		var width = margin.left + 450 + margin.right;
	    
		// set the height of the individual site instance component
		var height = 50 - margin.top - margin.bottom;
	
		// create the site instance visualization component
		var siteInstance = d3.siteInstanceView()
	    	.width(width)
	    	.height(height);
		
		// TODO: check for browser support?
	 	if(typeof(EventSource) !== "undefined") 
	 	{
		 	// define the event endpoint 
	 		var eSource = new EventSource("dataReq/?type=event");
		
	 		// detect message receipt to a event load
	 		eSource.onmessage = function(event) 
	 		{		 	 		
				// create/init the shells for all the site instances
				d3.json("dataReq/?type=init", function(error, data)
				{
					// erase all the site instances on error
					if (error || data.length == 0) 
					{
						curRendered = d3.selectAll(".siteInstanceView").remove();
						return;
					}
						
					// get the current rendered items
					var curRendered = d3.selectAll(".siteInstanceView").selectAll("svg");
	
					// do we have a valid site instance defined
					if(Array.isArray(curRendered))
					{
						// loop through the rendered site instances and remove ones with no incoming data 
						for(i=0; i<curRendered.length; i++)
						{
							// reset the found flag
							bfound = false;
							
							// for each id in the incoming data
							for(j=0; j<data.length; j++)
							{
								// was it previously rendered
								if(curRendered[i].parentNode.id == "_" + data[j].instance_id)
								{
									// set the flag
									bfound = true;
									
									// no need to continue
									break;
								}
							}
							
							// if data for this rendered item is not found remove it
							if(!bfound)
								curRendered[i].parentNode.remove();
						}
					}
					
				  	// render the svg region for all individual site instances
				  	var svg = d3.select("body").selectAll("svg")
					    .data(data)
					    .enter()
					    	.append("svg")
								.attr("id", function(d) {return "_" + d.instance_id;} )
								.attr("class", "siteInstanceView")
								.attr("width", width + 30)
								.attr("height", function(d) { // if this is an exited run collapse it by default
									if(d.instance_status == _CONST_EXIT_MSG_TYPE) 
										return '14px'; 
									else 
										return '75px';
									} )
								.append("g")
									.attr("transform", "translate(" + margin.left + "," + margin.top + ")")
									.call(siteInstance);				  		
					
					// create a region for the textual information
				  	var title = svg.append("g")
				      	.attr("transform", "translate(0, -5)");
				
					// handle the expand/collapse image area that controls each view instance
					title.append("image")
					    .attr("xlink:href","{% static 'ASGS_Mon/images/down2.gif' %}")
					    .attr("width", 10)
					    .attr("height", 10)
						.attr("x", -13)
						.attr("y", -9)
						.on("click", function(d) 
						{
							// get a ref to the site instance rect (main rect for each instance)
							si = d3.select("#_" + d.instance_id);
							
							// get the size of the event message summary rect
							msgRect = d3.select("#_" + d.instance_id + "_rectX");
							
							// reset the event message area
							msgRect.transition()
								.duration(300)
									.attr("height", "14px")

							// if it is large
							if(parseInt(si.style('height')) >= 75)
							{
								// make it small, showing only the header
								si.transition()
									.duration(300)
										.attr("height", "14px");
								
								// adjust the direction image
								d3.select(this).attr({"xlink:href": "{% static 'ASGS_Mon/images/up2.gif' %}"});
							}
							else
							{
								// make it full size
								si.transition()
									.duration(300)
										.attr("height", "75px");
																
								// adjust the direction image
								d3.select(this).attr({"xlink:href": "{% static 'ASGS_Mon/images/down2.gif' %}"});
							}
						})

					// append the site name
					title.append("text")
					    .text(function(d) { return d.title + " - " + d.instance_name; })
					    .attr("class", "title");
				  	  
					// append the process run state. colored RGB later
					title.append("text")
						.text("Working...")
						.attr("id", function(d) { return "_" + d.instance_id + "_state"; })
						.attr("class", "stateSm")
			      		.attr("fill", "gray")
						.attr("x", width/2 - 40);

					// append the event operation message text that goes inside the bar graph
					svg.append("g")
						.attr("transform", "translate(6," + height / 2 + ")")
							.append("text")
								.text("Working...")
								.attr("id", function(d) { return "_" + d.instance_id + "_operation"; })
					      		.attr("fill", "gray")
								.attr("class", "state")
								.attr("dy", ".35em");

					// append the run parameters text
					svg.append("g")
				      	.style("text-anchor", "end")
						.attr("transform", "translate(" + width + ", -5)")
							.append("text")
								.attr("id", function(d) { return "_" + d.instance_id + "_params"; })
								.attr("class", "params")
								.text(function(d) { return "Run params: " + d.run_params; });					 	 		

					// create a rect for the event summary text
					var lastEventBox = svg.append("g")
			      		.attr("transform", "translate(-10, 35)");
					
					// load the event messages rectangle
					lastEventBox.append("rect")
							.attr("id", function(d) { return "_" + d.instance_id + "_rectX"; })
							.attr("class", "eventBox")
							.attr("height", 14)
							.attr("width", 0)
							.on("click", function(d) 
							{
								// get a ref to the rectangle the event msg is in
								msgRect = d3.select("#_" + d.instance_id + "_rectX");

								// get a ref to the site instance
								si = d3.select("#_" + d.instance_id);
																
						    	// get a reference to the event text area
						    	var textarea = d3.select("#_" + d.instance_id + "_eventSummary");
							  
						    	// remove all instances of the current text messages
						    	textarea.selectAll("text").remove();

						    	// get the event messages
							    var eventMsgs = d.event_raw_msgs;

								// if it is large
								if(msgRect.style('height') == "75px")
								{
									// make it regular size
									msgRect.transition()
										.duration(300)
											.attr("height", "14px")		
											
									// make it full size
									si.transition()
										.duration(300)
											.attr("height", "75px")
											
						    		textarea
							    	.append("text")
									.attr("class", "eventSummary")
								    .text(function(d) 
								    	{
								    		var ellipsis = '';
								    		
								    		if(eventMsgs[0].event_summary.length > 175)
								    			ellipsis = '...';
								    			
								    		return eventMsgs[0].event_summary.substring(0, 175) + ellipsis; 
								    	});
								}
								else
								{
									// make it small, showing only the header
									msgRect.transition()
										.duration(300)
											.attr("height", "75px")
									
									// make it full size
									si.transition()
										.duration(300)
											.attr("height", "135px")											
											
							    	// loop through the messages
								    eventMsgs.forEach(function(info, i)
								    	{
								    		// output the text
								    		textarea
										    	.append("text")
										    	.attr("class", "eventSummary")
										    	.attr("transform", "translate(0, " + i * 10 +")")
											    .text(function(d) 
											    	{
											    		var ellipsis = '';
											    		
											    		if(eventMsgs[0].event_summary.length > 175)
											    			ellipsis = '...';
										    			
											    		return info.event_summary.substring(0, 175) + ellipsis; 
											    	});
								    	});
								}
							})							
							.transition()
								.duration(1000)
								.attr("width", 500);

					// output a place holder for the eventual event summary
		      		lastEventBox.append("g")				
			      		.attr("transform", "translate(3, 9)")
						.attr("id", function(d) { return "_" + d.instance_id + "_eventSummary"; });
				});
				
	 	 		// parse the incoming data object
	 	 		var theMsg = JSON.parse(event.data);
	 	 		 	 		
	 	 		// get a reference to the visualization component
	 			var svg = d3.select("body").selectAll("svg");
	 			
	 	 		// reload the visualization with the new data
	 			svg.data(theMsg.utilization).call(siteInstance.duration(1500));
	 		}
	 	}
	</script>
</body>
